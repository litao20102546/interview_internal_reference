

kubernetes 中的垃圾回收机制主要有两部分组成：

- 一是由 kube-controller-manager 中的 gc controller 自动回收 kubernetes 中被删除的对象以及其依赖的对象；

- 二是在每个节点上需要回收已退出的容器以及当 node 上磁盘资源不足时回收已不再使用的容器镜像；

  

# kubernetes删除

kubernetes 中有三种删除策略：

* Orphan

  非级联删除，删除对象时，不会自动删除它的依赖或者是子对象，这些依赖被称作是原对象的孤儿对象

* Foreground

  在该模式下，对象首先进入“删除中”状态，即会设置对象的 `deletionTimestamp` 字段并且对象的 `metadata.finalizers` 字段包含了值 “foregroundDeletion”，此时该对象依然存在，然后垃圾收集器会删除该对象的所有依赖对象，垃圾收集器在删除了所有“Blocking” 状态的依赖对象（指其子对象中 `ownerReference.blockOwnerDeletion=true`的对象）之后，然后才会删除对象本身；

* Background

  在该模式下，kubernetes 会立即删除该对象，然后垃圾收集器会在后台删除这些该对象的依赖对象；

## finalizer 机制

finalizer 是在删除对象时设置的一个 hook，其目的是为了让对象在删除前确认其子对象已经被完全删除，k8s 中默认有两种 finalizer：`OrphanFinalizer` 和 `ForegroundFinalizer`，finalizer 存在于对象的 ObjectMeta 中，当一个对象的依赖对象被删除后其对应的 finalizers 字段也会被移除，只有 finalizers 字段为空时，apiserver 才会删除该对象



#  kubelet删除

## 参数

kubelet 中与容器垃圾回收有关的主要有以下三个参数:

- `--maximum-dead-containers-per-container`: 表示一个 pod 最多可以保存多少个已经停止的容器，默认为1；（maxPerPodContainerCount）
- `--maximum-dead-containers`：一个 node 上最多可以保留多少个已经停止的容器，默认为 -1，表示没有限制；
- `--minimum-container-ttl-duration`：已经退出的容器可以存活的最小时间，默认为 0s；

与镜像回收有关的主要有以下三个参数：

- `--image-gc-high-threshold`：当 kubelet 磁盘达到多少时，kubelet 开始回收镜像，默认为 85% 开始回收，根目录以及数据盘；
- `--image-gc-low-threshold`：回收镜像时当磁盘使用率减少至多少时停止回收，默认为 80%；
- `--minimum-image-ttl-duration`：未使用的镜像在被回收前的最小存留时间，默认为 2m0s；

## 回收过程

* kubelet 中容器回收过程如下:

  pod 中的容器退出时间超过`--minimum-container-ttl-duration`后会被标记为可回收，一个 pod 中最多可以保留`--maximum-dead-containers-per-container`个已经停止的容器，一个 node 上最多可以保留`--maximum-dead-containers`个已停止的容器。**在回收容器时，kubelet 会按照容器的退出时间排序，最先回收退出时间最久的容器**。需要注意的是，kubelet 在回收时会将 **pod 中的 container 与 sandboxes 分别进行回收**，且在回收容器后会将其对应的 **log dir** 也进行回收；

* **kubelet 中镜像回收过程如下**

  当容器镜像挂载点文件系统的磁盘使用率大于`--image-gc-high-threshold`时（containerRuntime 为 docker 时，镜像存放目录默认为 `/var/lib/docker`），kubelet 开始删除节点中未使用的容器镜像，直到磁盘使用率降低至`--image-gc-low-threshold` 时停止镜像的垃圾回收。